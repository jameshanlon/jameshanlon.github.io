<!DOCTYPE html>
<!-- Make light mode the default for articles since this works better with
    images with a white background and code highlighting. -->
<html lang="en" data-bs-theme=light>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="author" content="James W. Hanlon">
  <title>A convolutional neural network fromÂ scratch</title>
  <link rel="icon" type="image/png" sizes="32x32" href="./theme/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./theme/images/favicon-16x16.png">
  <!-- Default Pygments style -->
  <link rel="stylesheet" type="text/css" href="./theme/css/pygments.css" id="pygments-style"/>
  <link rel="stylesheet" type="text/css" href="./theme/css/main.css"/>
  <link href="https://jameswhanlon.com/reeds/atom.xml"
        type="application/atom+xml" rel="alternate"
        title="James W. Hanlon Atom Feed" />
  <link href="https://jameswhanlon.com/reeds/rss.xml"
        type="application/rss+xml" rel="alternate"
        title="James W. Hanlon RSS Feed" />
  <!-- MathJax -->
  <script>
  MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
              svg: { fontCache: 'global' } };
  </script>
  <script type="text/javascript" id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
  </script>
  <script src="./theme/js/bundle.js"></script>
  <script data-goatcounter="https://jameswhanlon.goatcounter.com/count"
          async src="//gc.zgo.at/count.js"></script>
</head>
<body>
  <header>
  <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarCollapse">
        <ul class="navbar-nav me-auto mb-2 mb-md-0 text-uppercase">
          <li class="nav-item">
              <a class="nav-link" href="/index.html">notes</a>
          </li>
          <li class="nav-item">
              <a class="nav-link" href="/projects.html">projects</a>
          </li>
          <li class="nav-item">
              <a class="nav-link" href="/archive.html">archive</a>
          </li>
          <li class="nav-item">
              <a class="nav-link" href="/about.html">about</a>
          </li>
          <li class="nav-item">
              <a class="nav-link" href="/links.html">links</a>
          </li>
        </ul>
        <a class="navbar-brand" href="#">James W. Hanlon</a>
        <button class="btn btn-secondary" type="button" onclick="toggleMode(this)">
          <!-- Initial button state -->
            <i class="bi bi-moon-fill"></i>
        </button>
      </div>
    </div>
  </nav>
  </header>

  <main class="flex-shrink-0">
  <div class="container">
  <h1>
    A convolutional neural network from&nbsp;scratch
  </h1>
  <div class="lead">
    <time class="published" datetime="2017-02-10T00:00:00+01:00">
      10 Feb 2017
    </time><br>
      <span class="article-tag small"><a href="/tag/machine-intelligence.html">machine-intelligence</a></span>
  </div>
  <div class="article-body">
    <p>The online book &#8216;<a href="http://neuralnetworksanddeeplearning.com">Neural Networks and Deep
Learning</a>&#8216; by Michael Nielsen is an
excellent introduction to neural networks and the world of deep learning.  As
the book works through the theory, it makes it concrete by explaining how the
concepts are implemented using Python. The complete Python programs are
<a href="https://github.com/mnielsen/neural-networks-and-deep-learning">available on
Github</a> for
further inspection and&nbsp;experimentation.</p>
<p>I decided to write my own implementations of the examples however. Partly to
develop a better understanding but also because I felt that the matrix-based
presentation of the mathematics and use of NumPy operations in the examples
obscured some of the intuition around neurons and their connections, and
because the later examples of convolutional layers are implemented using
<a href="deeplearning.net/software/theano/">Theano</a>.</p>
<p>So, in the hope that it might be interesting as a simple and self-contained
example of a convolutional neural network where nothing is hidden, I&#8217;ve put he
source code for my implementation (written in C++) on
<a href="https://github.com/jameshanlon/convolutional-neural-network">GitHub</a>. For
reference I&#8217;ve also written up below the various equations for the
fully-connected and convolutional layers in element-wise notation. I should
thank two particularly useful blog posts by <a href="http://andrew.gibiansky.com/blog/machine-learning/convolutional-neural-networks/">Andrew
Gibiansky</a>
and <a href="https://grzegorzgwardys.wordpress.com/2016/04/22/8/">Grzegorz Gwardys</a>
which helped me to derive the convolutional equations for back&nbsp;propagation.</p>
<h1>The source&nbsp;code</h1>
<p>The <a href="https://github.com/jameshanlon/convolutional-neural-network">repository</a>
contains several example programs with different network
configurations. They are instantiated from a generic&nbsp;header <code>Network.hpp</code>,
which contains classes for fully-connected, softmax, convolutional and
max-pooling layer types, and a network class that performs the stochastic
gradient descent, minibatching and training over multiple epochs with
randomly-shuffled training data. The header also contains definitions for
quadratic and cross-entropy cost functions, and sigmoid and rectified-linear
activation functions, which are specified as template parameters to the
network. The code is written primarily primarily to be clear and
understandable, as such there will be many opportunities for optimisations and
other improvements (please let me know if you have any&nbsp;suggestions).</p>
<p>For instructions on how to build and run the examples, see&nbsp;the <code>README.md</code>
file. Note that Boost is required&nbsp;for <code>multi_array</code> and Threading Building
Blocks to parallelise the training over minibatches and accuracy evaluation by
performing inferences in parallel, up to the minibatch size.  It should be
straightforward to build other network configurations or to modify the
implementations or to experiment with new&nbsp;features.</p>
<p>Included in&nbsp;the <code>extra</code> folder, are implementations of the example programs
in <a href="https://www.tensorflow.org/">TensorFlow</a>, adapted from the <a href="https://www.tensorflow.org/tutorials/mnist/pros/"><span class="caps">MNIST</span>
tutorial</a>. I found these
useful as a point of comparison to validate the behaviour of the&nbsp;networks.</p>
<h1>Equations</h1>
<p>The following notation roughly follows the notation in the Neural Networks and
Deep Learning&nbsp;book:</p>
<ul>
<li>$l$ is an index of a&nbsp;layer;</li>
<li>$w$ is a&nbsp;weight;</li>
<li>$z$ is a weighted&nbsp;input;</li>
<li>$a$ is an&nbsp;activation;</li>
<li>$y$ is a&nbsp;label;</li>
<li>$\delta$ is an&nbsp;error;</li>
<li>$\sigma$ is the activation function, $\sigma&#8217;$ is the derivative of&nbsp;it;</li>
<li>$C$ is the cost&nbsp;function.</li>
</ul>
<h2>For a fully-connected&nbsp;layer</h2>
<p>In the forward pass, each neuron takes a weighted sum of its inputs, adds the bias
and uses the result as the input to the activation function:
$$z_i^l = \sum_j w_{j,i}^{l-1} a_j^{l-1} + b^l$$
$$a_i^l =&nbsp;\sigma(z_i^l)$$</p>
<p>The error of a neuron $i$ in the output layer is given by
$\delta_i = (a_i -y_i)\sigma&#8217;(z_i)$
for the sigmoid activation function and by
$\delta_i = a_i - y_i$
for the cross-entropy activation&nbsp;function.</p>
<p>In the backwards pass, errors are propagated to a neuron from neurons that are
connected as outputs.  The weighted sum of the output neuron&#8217;s errors and
connection weight is calculated and this value is then multiplied by the
derivative of the activation function:
$$\delta_i^l = \sum_j w_{j,i}^{l+1} \delta_j^{l+1}&nbsp;\sigma&#8217;(z_i^l)$$</p>
<p>The delta for a weight is calculated from the error held by a neuron and the
activation from the neuron connected by the input:
$$\frac{\partial C}{\partial w_i^l} =&nbsp;a_i^{l-1}\delta_i^l$$</p>
<p>The delta for the bias is equal to the error held by a neuron:
$$\frac{\partial C}{\partial b_i^l} =&nbsp;\delta_i^l$$</p>
<h2>For a convolutional&nbsp;layer</h2>
<p>Assuming a two-dimensional input of size $N\times N$ and convolutional mask of
size $m\times&nbsp;m$.</p>
<p>In the forward pass, each neuron convolves the weights with its receptive field:
$$z_{x,y}^l = \sum_{a=0}^{m-1}\sum_{b=0}^{m-1} w_{a,b}^{l-1}a_{x+a,y+b}^{l-1} + b^l$$
$$a_{x,y}^l =&nbsp;\sigma(z_{x,y}^l)$$</p>
<p>In the backwards pass, errors are propagated to a neuron from the neurons
connected as outputs in the next layer:
$$\delta_{x,y}^l = \sum_{a=0}^{m-1}\sum_{b=0}^{m-1} w_{a,b}^{l+1}\delta_{x-a,y-b}^{l+1}\sigma&#8217;(z_{x,y}^l)$$
One way to simplify this is to <a href="https://grzegorzgwardys.wordpress.com/2016/04/22/8/">think of the convolutional layer as one
dimensional</a> (as with a
fully-connected layer), where each neuron has only $m\times m$ inputs connections.
Then, back propagation operates in the same way as it does with fully-connected
layers. You can in fact use this approach to derive the above&nbsp;equation.</p>
<p>The delta of a weight is calculated from the activations in the previous layer
that influence that weight and the errors held by the neurons that use it:
$$\frac{\partial C}{\partial w_{a,b}^l} = \sum_{i=0}^{N-m}\sum_{j=0}^{N-m} a_{i+a,&nbsp;j+b}^{l-1}\delta_{i,j}^l$$</p>
<p>The delta of a bias is calculated from the errors held by the neurons that
use it:
$$\frac{\partial C}{\partial b^l} = \sum_{i=0}^{N-m}\sum_{j=0}^{N-m}&nbsp;\delta_{i,j}^l$$</p>
<p>With three-dimensional inputs, convolutional layers convolve a
three-dimensional mask into the depth of the input. Convolutional layers can
themselves produce three-dimensional outputs by stacking up separate
convolutional processes in the same layer (called feature maps or channels),
each contributing one element in the depth of the output. In this case, the
backpropagation of the error must sum over the feature maps to get the
contributions of each expression that contribute to the error. The weight and
bias updates must sum errors over the input volume they are applied&nbsp;to.</p>
<h1>Further&nbsp;reading</h1>
<ul>
<li><a href="http://deeplearning.net/tutorial/lenet.html">Convolutional neural networks&nbsp;tutorial</a></li>
<li><a href="http://cs231n.github.io/">CS231n Convolutional Neural Networks for Visual&nbsp;Recognition</a></li>
<li><a href="http://russellsstewart.com/notes/0.html">Introduction to debugging neural&nbsp;networks</a></li>
</ul>
  </div>
  <div class="article-footer">
    <p>Please get in touch (mail @ this domain) with any
    comments, corrections or suggestions.</p>
  </div>
  </div>
  </main>

  <hr>
  <footer class="text-muted">
    <div class="container">
      <div class="small">
        <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
          <img alt="Creative Commons Licence" style="border-width:0"
               src="https://i.creativecommons.org/l/by/4.0/80x15.png" />
        </a>
        <br>
        Unless otherwise noted, all content is freely available under a
        <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
          Creative Commons Attribution 4.0 International License</a>.<br>
        The views expressed on this website are the authorâs personal views and should not be
        attributed to any other person, including that of their employer.<br>
        <br>
        Subscribe: <a href="https://jameswhanlon.com/reeds/atom.xml">Atom</a> /
        <a href="https://jameswhanlon.com/reeds/rss.xml">RSS</a>
      </div>
    </div>
  </footer>
  <script>
    function toggleMode(x) {
      // Toggle the colour mode in Bootstrap.
      if (document.documentElement.getAttribute('data-bs-theme') == 'dark') {
        document.documentElement.setAttribute('data-bs-theme','light')
      }
      else {
        document.documentElement.setAttribute('data-bs-theme','dark')
      }
      // Toggle the light/dark icon.
      x.firstElementChild.classList.toggle('bi-brightness-high-fill');
      x.firstElementChild.classList.toggle('bi-moon-fill');
      // Toggle the Pygments style.
      var elem = document.getElementById('pygments-style');
      if (elem.getAttribute('href') == './theme/css/pygments-dark.css') {
        elem.setAttribute('href', './theme/css/pygments.css');
      } else {
        elem.setAttribute('href', './theme/css/pygments-dark.css');
      }
    }
  </script>
</body>
</html>